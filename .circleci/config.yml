# Reference: https://circleci.com/docs/configuration-reference
version: 2.1

executors:
  linux-python:
    docker:
      - image: cimg/python:3.10.13

commands:
  full_install_steps:
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            pip install poetry
            poetry install -E tf -E pytorch -E trees -q || true
  dev_install_steps:
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            pip install poetry
            poetry install --only dev -q || true

jobs:
  code-quality:
    executor: linux-python
    steps:
      - checkout
      - run:
          name: "Run pre-commit hooks"
          command: |
            pip install pre-commit
            make check
            if ! git diff --quiet; then echo 'Style checks failed, please install pre-commit and run pre-commit run --all and push the change'; exit 1; fi

  build-documentation-wheel:
    executor: linux-python
    steps:
      - full_install_steps
      - run:
          name: "Build documentation"
          command: make docs
      - run: 
          name: "Build wheel"
          command: make build
      - run: 
          name: "Install wheel"
          command: python -m pip install dist/*.whl

  test-tf:
    executor: linux-python
    resource_class: large
    steps:
      - dev_install_steps
      - run:
          name: "Test with TensorFlow"
          command: poetry run tox -e 'py310-test-tf'

  test-pytorch:
    executor: linux-python
    resource_class: large
    steps:
      - dev_install_steps
      - run:
          name: "Test with PyTorch"
          command: poetry run tox -e 'py310-test-pytorch'

  publish-wheel:
    executor: linux-python
    steps:
      - checkout
      - run:
          name: "Publish wheel"
          command: make build-and-publish

  publish-documentation:
    executor: linux-python
    steps:
      - full_install_steps
      - run:
          name: "Publish docs"
          command: make docs-and-publish

workflows:
  build_and_test:
    jobs:
      - code-quality
      - build-documentation-wheel
      - test-tf
      - test-pytorch

      # TODO: rdar://120414177 (optional CI for docker image (build only))
      #- build-images:
      #    # Only verify build images on release candidates.
      #    filters:
      #      branches:
      #        only: /^release-.*/

      - publish-wheel:
          # Only publish package on new tag.
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - publish-documentation:
          # Only publish docs on commit to main.
          filters:
            branches:
              only: main




