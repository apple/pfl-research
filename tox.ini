[tox]
skipsdist = true
envlist = py{310}-test-{tf,pytorch}
# When running tox in parallel, we need to avoid any race conditions with the port numbers for
# the multi-worker tests. These conflicts are solved using a unique integer > 0 passed as TOX_ENV_ID.
parallel = all

[testenv]
allowlist_externals = poetry, bash
# Need a unique integer env variable per run to avoid port conflicts.
setenv = 
    py310-test-tf: TOX_ENV_ID=0
    py310-test-pytorch: TOX_ENV_ID=1
addscript = build_scripts

# tox -e setup-tf need to be run separately before the tf test command is
# invoked. It is split up such that setup-* can be cached by CI.
[testenv:setup-tf]
commands =
    poetry install --with dev -E tf -E trees
    poetry run ./build_scripts/install_horovod.sh true false false #true

[testenv:setup-pytorch]
commands =
    bash ./build_scripts/install_pytorch_always_true.sh
    poetry run ./build_scripts/install_horovod.sh false true false #true

[testenv:py310-test-tf]
commands =
    poetry run pytest tests/ --durations 0 --disable_slow {posargs}
depends = setup-tf

[testenv:py310-test-pytorch]
commands =
    poetry run pytest tests/ --durations 0 --disable_slow {posargs}
depends = setup-pytorch

